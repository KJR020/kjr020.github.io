# Implementation Plan

## Tasks

- [x] 1. 目次コンポーネントの基盤構築
- [x] 1.1 (P) スクロール位置検出フックを作成する
  - Intersection Observerを使用して見出し要素の可視状態を監視する
  - 複数の見出しがビューポート内にある場合、最上部の見出しをアクティブとして返す
  - コンポーネントアンマウント時にObserverをクリーンアップする
  - rootMarginオプションでヘッダー高さを考慮できるようにする
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 1.2 (P) 見出し情報の型定義を作成する
  - 見出しID、テキスト、レベル（h2/h3）を持つ型を定義する
  - 記事ページから目次コンポーネントに渡すprops型を定義する
  - _Requirements: 1.1_

- [x] 2. 目次リスト表示機能の実装
- [x] 2.1 目次リストコンポーネントを作成する
  - 見出しの階層構造を維持して表示する（h3はh2の下にインデント）
  - 各目次項目をクリック可能なリンクとして表示する
  - アクティブな項目をハイライト表示する
  - キーボードナビゲーションに対応する
  - aria-current属性でアクティブ状態をスクリーンリーダーに通知する
  - _Requirements: 1.2, 1.4, 2.1, 2.2, 5.2, 5.3_

- [x] 2.2 目次項目クリック時のナビゲーション機能を実装する
  - クリックした見出しまでスムーズにスクロールする
  - スクロール完了後にクリックした項目をアクティブ状態にする
  - URLハッシュをクリック時のみ更新する（スクロールでは更新しない）
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 3. アバターアイコン表示機能の実装
- [x] 3.1 アバターコンポーネントを作成する
  - public/ディレクトリの静的画像を読み込んで表示する
  - 丸いアバター画像として表示する（border-radius）
  - サイズをpropsで指定可能にする（デフォルト20px）
  - _Requirements: 6.1, 6.2_

- [x] 3.2 アバターの移動アニメーションを実装する
  - アクティブな目次項目の左側にアバターを配置する
  - アクティブ項目が変わった時にスムーズに移動する
  - CSS transitionで移動アニメーションを実現する
  - ページ読み込み時は最初の見出しに表示する
  - _Requirements: 6.1, 6.3, 6.4_

- [x] 4. レスポンシブ対応の実装
- [x] 4.1 デスクトップ表示（スティッキーサイドバー）を実装する
  - 記事の右側に目次を固定表示する
  - スクロールしても画面内に表示され続けるようにする
  - ダークモード/ライトモードの両方に対応したスタイルを適用する
  - _Requirements: 4.1, 4.3, 4.4_

- [x] 4.2 モバイル用折りたたみ目次コンポーネントを作成する
  - 記事上部に折りたたみ可能なアコーディオン形式で表示する
  - 開閉ボタンでスムーズに展開/折りたたみする
  - aria-expanded属性で開閉状態をスクリーンリーダーに通知する
  - モバイルではアバターアイコンを非表示にする
  - _Requirements: 4.2, 4.5, 5.4, 6.1_

- [x] 5. 目次コンテナと記事ページの統合
- [x] 5.1 目次コンテナコンポーネントを作成する
  - 記事内のh2/h3要素を抽出して目次を生成する
  - 見出しがない場合は目次を表示しない
  - デスクトップ/モバイル表示を切り替える
  - 適切なARIA属性（nav, aria-label）を設定する
  - _Requirements: 1.1, 1.3, 5.1_

- [x] 5.2 記事ページに目次コンポーネントを組み込む
  - 記事レイアウトを2カラム構成に変更する（デスクトップ）
  - TableOfContentsコンポーネントをclient:loadでハイドレーションする
  - アバター画像のパスをpropsで渡せるようにする
  - _Requirements: 1.1, 4.1, 6.2_

- [x] 6. テストの実装
- [x] 6.1 (P) スクロール位置検出フックのユニットテストを作成する
  - Intersection Observerをモックしてテストする
  - 見出しがビューポートに入った時にactiveIdが更新されることを確認する
  - 複数の見出しがビューポート内にある時に最上部が選択されることを確認する
  - アンマウント時にObserverがクリーンアップされることを確認する
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [ ] 6.2 (P) 目次コンポーネントのコンポーネントテストを作成する
  - 見出し一覧が正しく表示されることを確認する
  - h3がインデントされて表示されることを確認する
  - activeIdが渡された時に該当項目がハイライトされることを確認する
  - _Requirements: 1.2, 2.1_

- [ ]* 6.3 E2Eテストを作成する
  - 記事ページで目次が表示されることを確認する
  - スクロールでアクティブ項目が変わることを確認する
  - 目次クリックで該当セクションにスクロールすることを確認する
  - モバイルでアコーディオンが開閉することを確認する
  - _Requirements: 1.1, 2.1, 3.1, 4.2_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 1.2, 5.1, 5.2 |
| 1.2 | 2.1 |
| 1.3 | 5.1 |
| 1.4 | 2.1 |
| 2.1 | 1.1, 2.1, 6.1, 6.2 |
| 2.2 | 1.1, 2.1, 6.1 |
| 2.3 | 1.1, 6.1 |
| 2.4 | 1.1, 6.1 |
| 3.1 | 2.2 |
| 3.2 | 2.2 |
| 3.3 | 2.2 |
| 4.1 | 4.1, 5.2 |
| 4.2 | 4.2 |
| 4.3 | 4.1 |
| 4.4 | 4.1 |
| 4.5 | 4.2 |
| 5.1 | 5.1 |
| 5.2 | 2.1 |
| 5.3 | 2.1 |
| 5.4 | 4.2 |
| 6.1 | 3.1, 3.2, 4.2 |
| 6.2 | 3.1, 5.2 |
| 6.3 | 3.2 |
| 6.4 | 3.2 |
