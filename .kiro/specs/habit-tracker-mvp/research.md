# リサーチと設計判断

## サマリー
- **機能**: `habit-tracker-mvp`
- **調査スコープ**: 新規機能（グリーンフィールド）
- **主な発見**:
  - Rustシングルバイナリ CLIは、低リソースオーバーヘッドでmacOSバックグラウンドデーモンに最適
  - osascript経由のAppleScriptは、グレースフルフォールバック付きでアクティブアプリ/ウィンドウタイトル取得に信頼性が高い
  - rusqliteを使用したSQLiteは、ファイルベースの永続化で堅牢なローカルファーストストレージを提供

## リサーチログ

### macOSスクリーンショットキャプチャ
- **コンテキスト**: ユーザーへの影響を最小限に抑えながら、定期的にスクリーンショットをキャプチャする必要がある
- **参照元**: macOS screencaptureマニュアルページ、Apple Developer ドキュメント
- **発見**:
  - `screencapture -x -t jpg -q <quality> <path>` はシャッター音なしでサイレントにキャプチャ
  - `-x` フラグはキャプチャ音を防止
  - `-t jpg` はファイルサイズを小さくするためにJPEG形式を指定
  - `-q` (0-100) は圧縮品質を制御; 60が良いバランスを提供
  - システム環境設定 > プライバシーとセキュリティで画面収録権限が必要
- **影響**: std::process::Commandを使用してscreencaptureを呼び出す; 権限エラーを優雅に処理

### AppleScript経由のアクティブアプリケーション検出
- **コンテキスト**: ユーザーが現在使用しているアプリケーションを特定する必要がある
- **参照元**: AppleScript言語ガイド、macOS自動化ドキュメント
- **発見**:
  - `osascript -e 'tell application "System Events" to get name of first process whose frontmost is true'` はアクティブアプリ名を返す
  - ウィンドウタイトルにはアクセシビリティ権限が必要で、一部のアプリでは失敗する可能性がある
  - `osascript -e 'tell application "System Events" to get name of front window of first process whose frontmost is true'`
  - 一部のアプリケーション（例: Chrome、VS Code）はウィンドウタイトルを公開; その他は公開しない可能性
- **影響**: ウィンドウタイトル取得は常にエラーハンドリングでラップ; フォールバックとして空文字列を使用

### rusqliteを使用したSQLite
- **コンテキスト**: キャプチャメタデータを保存するための信頼性の高いローカルデータベースが必要
- **参照元**: rusqliteドキュメント (crates.io)、SQLiteベストプラクティス
- **発見**:
  - rusqlite 0.32.xは現在の安定版で、tokio-rusqlite経由の良好な非同期サポートがある
  - シングルプロセスCLIにはコネクションプーリングは不要
  - WALモードは並行読み取りパフォーマンスを改善
  - プリペアドステートメントはSQLインジェクションを防ぎ、パフォーマンスを改善
- **影響**: MVPには同期rusqliteを使用; データベースオープン時にWALモードを有効化

### Rustクレート選定
- **コンテキスト**: Rust実装に最適なクレートを選定
- **参照元**: crates.io、lib.rs、GitHubリポジトリ
- **発見**:
  - `clap` (4.x): deriveマクロを使用した業界標準のCLI解析
  - `chrono` (0.4.x): タイムゾーンサポート付きの包括的な日時処理
  - `rusqlite` (0.32.x): 使いやすいSQLiteバインディング
  - `serde` + `toml`: 設定ファイル解析
  - `tracing` + `tracing-subscriber`: 構造化ログ
  - `thiserror`: 使いやすいエラー型定義
  - `anyhow`: アプリケーション向けの便利なエラー処理
- **影響**: すべてのクレートは適切にメンテナンスされ、互換性がある

### 一時停止/再開メカニズム
- **コンテキスト**: スクリーンショットキャプチャを一時的に無効にするシンプルなメカニズム
- **参照元**: Unixデーモンパターン、ファイルベースシグナリング
- **発見**:
  - ファイルベースフラグ（`~/.habit-tracker/pause`）が最もシンプルなアプローチ
  - ファイル存在チェックのパフォーマンス影響は無視できる程度
  - 代替案: Unixシグナル（SIGUSR1/SIGUSR2）- より複雑で移植性が低い
  - 代替案: 名前付きパイプ/ソケット - MVPには不要な複雑さ
- **影響**: 各キャプチャサイクル開始時にファイル存在チェックを使用

## アーキテクチャパターン評価

| オプション | 説明 | 強み | リスク / 制限 | 備考 |
|-----------|------|------|--------------|------|
| シングルバイナリCLI | サブコマンド付きモノリシックRustバイナリ | シンプルなデプロイ、ランタイム依存なし | 拡張性が限定的 | 個人用ツールに最適 |
| モジュラーライブラリ + CLI | 別々のlibとbinクレート | テスト容易性向上、再利用可能なロジック | プロジェクト構造がやや複雑 | 良い実践だがMVPには過剰な可能性 |
| デーモン + CLIクライアント | 別々のバックグラウンドデーモンと制御CLI | 関心の分離がクリーン | IPC複雑性、複数プロセス | バックグラウンドモードが必要な場合v2向け |

**選定**: モジュラー内部構造を持つシングルバイナリCLI。バイナリはフォアグラウンドキャプチャループとCLIコマンドの両方を処理。内部モジュールは外部IPC複雑性なしに関心の分離を提供。

## 設計判断

### 判断: ファイルベース一時停止メカニズム
- **コンテキスト**: ユーザーはプライバシーのためにキャプチャを素早く一時停止する方法が必要
- **検討した代替案**:
  1. ファイル存在チェック（`~/.habit-tracker/pause`）
  2. Unixシグナル（一時停止にSIGUSR1、再開にSIGUSR2）
  3. データベースフラグ（is_runningカラム）
- **選定アプローチ**: ファイル存在チェック
- **根拠**: 実装とデバッグが最もシンプル; プロセス再起動間でも動作; 状態確認が容易（`ls ~/.habit-tracker/pause`）
- **トレードオフ**: 各サイクルでファイルシステムアクセスが必要（コストは無視できる程度）
- **フォローアップ**: MVPでは不要

### 判断: 画像ストレージ構造
- **コンテキスト**: 潜在的に数千枚のスクリーンショットのための整理されたストレージが必要
- **検討した代替案**:
  1. UUIDファイル名のフラットディレクトリ
  2. 日付ベース階層（YYYY-MM-DD/HHMMSS.jpg）
  3. 時間別サブディレクトリ（YYYY-MM-DD/HH/MMSS.jpg）
- **選定アプローチ**: 日付ベース階層（YYYY-MM-DD/HHMMSS.jpg）
- **根拠**: 手動でブラウズしやすい; 日次レポートと自然に一致; 日付別のクリーンアップがシンプル
- **トレードオフ**: 忙しい日にはディレクトリが大きくなる可能性（1分間隔で最大約1440ファイル）
- **フォローアップ**: ディレクトリサイズが問題になった場合、v2で時間別サブディレクトリを検討

### 判断: エラー処理戦略
- **コンテキスト**: バックグラウンドキャプチャは一時的な障害に対して回復力が必要
- **検討した代替案**:
  1. フェイルファスト: エラーでクラッシュ
  2. フェイルセーフ: エラーをログして継続
  3. バックオフ付きリトライ
- **選定アプローチ**: ログ付きフェイルセーフ
- **根拠**: 個人用トラッキングツールは厳格な一貫性より可用性を優先すべき
- **トレードオフ**: サイレント障害が見逃される可能性; ログレビューで軽減
- **フォローアップ**: v2でエラー率モニタリングを追加

### 判断: 設定の優先順位
- **コンテキスト**: ユーザーは柔軟な設定オプションが必要
- **検討した代替案**:
  1. 設定ファイルのみ
  2. CLI引数のみ
  3. CLI引数が設定ファイルを上書き
- **選定アプローチ**: CLI引数が設定ファイルを上書き、適切なデフォルト付き
- **根拠**: 標準的なUnix規約; 設定を変更せずにクイックテストが可能
- **トレードオフ**: 引数処理がやや複雑
- **フォローアップ**: なし

## リスクと軽減策
- **リスク**: macOS権限ダイアログがユーザーを混乱させる可能性
  - **軽減策**: READMEに必要な権限を記載; 初回実行時のガイダンスを提供
- **リスク**: 大量のスクリーンショット蓄積がディスク容量を消費
  - **軽減策**: デフォルトでquality=60; クリーンアップ手順を記載; v2で保持ポリシー
- **リスク**: 特定のアプリでウィンドウタイトル取得が失敗
  - **軽減策**: 空文字列への優雅なフォールバック; 制限を記載
- **リスク**: 予期しない終了によるデータベース破損
  - **軽減策**: WALモードを使用; SQLiteが自動的にリカバリを処理

## 参考資料
- [rusqliteドキュメント](https://docs.rs/rusqlite) — Rust用SQLiteバインディング
- [clapドキュメント](https://docs.rs/clap) — コマンドライン引数パーサー
- [chronoドキュメント](https://docs.rs/chrono) — 日付と時刻ライブラリ
- [macOS screencaptureマニュアルページ](https://ss64.com/osx/screencapture.html) — スクリーンショットユーティリティリファレンス
- [AppleScript言語ガイド](https://developer.apple.com/library/archive/documentation/AppleScript/Conceptual/AppleScriptLangGuide/) — macOS自動化
