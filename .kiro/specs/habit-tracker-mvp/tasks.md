# 実装計画

## タスク1: プロジェクトセットアップとコアインフラ
- [x] 1.1 CargoでRustプロジェクトを初期化
  - バイナリターゲットで新しいCargoプロジェクトを作成
  - すべての必要な依存関係（clap、rusqlite、chrono、serde、toml、tracing、tracing-subscriber、thiserror、anyhow、ctrlc）でCargo.tomlを設定
  - 設計アーキテクチャに従ってモジュール構造をセットアップ
  - コンパイラ設定とエディションを設定
  - _要件: 1.1_

- [x] 1.2 (P) 全モジュールのエラー型を実装
  - IoError、ParseError、DirectoryCreationErrorバリアント付きのConfigErrorを定義
  - SqliteError、IoError、MigrationErrorバリアント付きのDatabaseErrorを定義
  - CommandFailed、Utf8Errorバリアント付きのMetadataErrorを定義
  - CommandFailed、DirectoryCreationFailed、CaptureCommandFailedバリアント付きのImageStoreErrorを定義
  - DatabaseError、ConfigError、InitializationError、SignalHandlerErrorバリアント付きのCaptureErrorを定義
  - DatabaseError、InvalidDateバリアント付きのReportErrorを定義
  - 使いやすいエラー定義のためにthiserrorを使用
  - _要件: 3.5_

- [x] 1.3 (P) ログインフラをセットアップ
  - stderr出力でtracing-subscriberを初期化
  - ログレベル（ERROR、WARN、INFO、DEBUG）を設定
  - キャプチャ操作用の構造化ログフィールドを追加
  - _要件: 3.5_

## タスク2: 設定モジュール
- [x] 2.1 Config構造体とデフォルト値を実装
  - interval_seconds、jpeg_quality、db_path、images_dir、pause_fileフィールドを持つConfig構造体を定義
  - 適切なデフォルト（60秒間隔、品質60、~/.habit-tracker/パス）でDefaultトレイトを実装
  - interval_seconds > 0およびjpeg_quality 0-100範囲のバリデーションを追加
  - _要件: 5.2, 5.3_

- [x] 2.2 TOML設定ファイル読み込みを実装
  - ~/.habit-tracker/config.tomlから設定を読み込む
  - serdeとtomlクレートを使用してTOMLファイルを解析
  - ファイルがない場合はデフォルトにフォールバックして優雅に処理
  - 欠損フィールドにはデフォルトとファイル設定をマージ
  - _要件: 5.1, 5.3_

- [x] 2.3 ディレクトリ初期化を実装
  - 必要なディレクトリをセットアップするensure_directories()関数を作成
  - スクリーンショット保存用のimages_dirを作成
  - db_pathの親ディレクトリを作成
  - pause_fileの親ディレクトリを作成
  - Config::load()中にensure_directories()を呼び出す
  - ディレクトリ作成エラーを適切に処理
  - _要件: 3.1, 3.2_

## タスク3: データベースモジュール
- [x] 3.1 データベース初期化とスキーマを実装
  - 設定されたパスでSQLite接続を開く
  - クラッシュリカバリのためWALモードを有効化
  - id、captured_at、image_path、active_app、window_title、is_paused、is_privateカラム付きのcapturesテーブルを作成
  - 効率的な日付クエリのためcaptured_atにインデックスを作成
  - _要件: 3.1, 3.3, 3.4_

- [x] 3.2 CaptureRecord構造体と挿入操作を実装
  - すべてのフィールドを持つCaptureRecord DTOを定義
  - 新しいレコードを追加するinsert_capture()を実装
  - 安全性とパフォーマンスのためプリペアドステートメントを使用
  - データベースエラーをログに記録し、操作を継続
  - _要件: 1.6, 3.3, 3.5_

- [x] 3.3 日付ベースのクエリ操作を実装
  - YYYY-MM-DDでレコードをクエリするget_captures_by_date()を実装
  - captured_at LIKEパターンで日付範囲を解析
  - captured_atで順序付けされたVec<CaptureRecord>を返す
  - 空の結果を優雅に処理
  - _要件: 4.1, 4.2_

## タスク4: メタデータ収集モジュール
- [x] 4.1 AppleScript経由のアクティブアプリケーション検出を実装
  - osascriptを実行して最前面のアプリケーション名を取得
  - コマンド出力を解析し空白を削除
  - コマンド実行失敗を処理
  - 完全な失敗時のみエラーを返す
  - _要件: 1.3_

- [x] 4.2 AppleScript経由のウィンドウタイトル検出を実装
  - osascriptを実行して最前面のウィンドウタイトルを取得
  - コマンド出力を解析し、アプリ固有のバリエーションを処理
  - 失敗時はエラーではなく空文字列を返す（優雅なフォールバック）
  - ウィンドウタイトル取得失敗時に警告をログ
  - _要件: 1.4, 1.5_

## タスク5: 画像ストレージモジュール
- [x] 5.1 screencaptureコマンドを使用したスクリーンショットキャプチャを実装
  - -x（サイレント）、-t jpg、-q（品質）フラグ付きのscreencaptureコマンドを構築
  - 設定されたJPEG品質でコマンドを実行
  - 権限拒否エラーをガイダンス付きで処理
  - 成功時にキャプチャした画像パスを返す
  - _要件: 1.2_

- [x] 5.2 日付別ディレクトリ構造を実装
  - YYYY-MM-DD/HHMMSS.jpg形式で画像パスを生成
  - 日付ディレクトリが存在しない場合は作成
  - タイムスタンプを使用してユニークなファイル名を保証
  - 保存された画像へのフルパスを返す
  - _要件: 3.2_

## タスク6: 一時停止制御モジュール
- [x] 6.1 ファイルベースの一時停止メカニズムを実装
  - pause_fileパス付きのPauseControl構造体を作成
  - 空のフラグファイルを作成するpause()を実装
  - フラグファイルを削除するresume()を実装
  - ファイル存在をチェックするis_paused()を実装
  - ファイル操作エラーを処理
  - _要件: 2.1, 2.2, 2.3, 2.4_

## タスク7: キャプチャループモジュール
- [x] 7.1 CaptureLoop構造体と初期化を実装
  - Config、Database、Metadata、ImageStore、PauseControl、running flagを持つCaptureLoop構造体を作成
  - new()ですべての依存関係を初期化
  - シグナルハンドラーと共有するrunningフラグ用のArc<AtomicBool>をセットアップ
  - データベース接続を開く
  - _要件: 1.1_

- [x] 7.2 シグナルハンドリングによるグレースフルシャットダウンを実装
  - runningフラグをfalseに設定するctrlcハンドラーをセットアップ
  - Ctrl+CおよびSIGTERMシグナルを処理
  - 終了前に現在のサイクルが完了することを保証
  - シャットダウン開始をログ
  - _要件: 1.1_

- [x] 7.3 メインキャプチャループを実装
  - 各サイクル開始時にrunningフラグをチェック
  - 一時停止状態をチェックし、一時停止中はキャプチャをスキップ
  - メタデータ（アクティブアプリ、ウィンドウタイトル）を収集
  - 日付別ディレクトリにスクリーンショットをキャプチャ
  - データベースにキャプチャレコードを挿入
  - 設定された間隔でスリープ
  - クラッシュせずに個別のキャプチャエラーを処理・ログ
  - runningフラグがfalseになるまでループを継続
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 2.2, 2.4, 2.5_

## タスク8: レポートモジュール
- [x] 8.1 タイムライン生成を実装
  - 指定された日付のキャプチャをクエリ
  - 各エントリを時刻、アクティブアプリ、ウィンドウタイトルでフォーマット
  - 空の結果セットを適切なメッセージで処理
  - _要件: 4.1, 4.2, 4.3, 4.5_

- [x] 8.2 アプリ別時間計算を実装
  - アクティブアプリケーションでキャプチャをグループ化
  - キャプチャ数 × 間隔で時間を計算
  - 合計時間の降順でソート
  - アプリ名と時間/分で出力をフォーマット
  - _要件: 4.4_

- [x] 8.3 レポート出力フォーマットを実装
  - タイムラインとアプリ別時間セクションを結合
  - セクションヘッダーと区切りを追加
  - --dateと--todayオプションの両方をサポート
  - フォーマットされたレポートをstdoutに出力
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5_

## タスク9: CLIモジュール
- [x] 9.1 clapを使用したCLI引数解析を実装
  - Parser deriveでCli構造体を定義
  - Start、Pause、Resume、Reportサブコマンド付きのCommands enumを定義
  - Startコマンドに--intervalと--quality引数を追加
  - Reportコマンドにconflicts_with付きの--dateと--today引数を追加
  - すべてのコマンドにヘルプテキストを追加
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

- [x] 9.2 CLI引数による設定上書きを実装
  - コマンドラインから--intervalと--qualityを受け付ける
  - CLI引数が提供された場合に設定ファイル値を上書き
  - CLI引数値をバリデート
  - _要件: 5.4_

- [x] 9.3 コマンドディスパッチとmainエントリポイントを実装
  - main()でCLI引数を解析
  - CLI上書き付きで設定を読み込む
  - コマンドに基づいて適切なハンドラーにディスパッチ
  - Startコマンド: キャプチャループを初期化・実行
  - Pauseコマンド: pause_control.pause()を呼び出す
  - Resumeコマンド: pause_control.resume()を呼び出す
  - Reportコマンド: レポートを生成・表示
  - anyhowでエラーを処理し、ユーザーフレンドリーなメッセージを表示
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

## タスク10: 統合およびE2Eテスト
- [x] 10.1 (P) コアモジュールのユニットテスト
  - 有効なTOMLでのConfig読み込みをテスト
  - ファイルがない場合のConfigデフォルトをテスト
  - Config CLI上書き優先順位をテスト
  - PauseControlファイル操作をテスト
  - Reportアプリ別時間計算をテスト
  - _要件: 5.1, 5.2, 5.3, 5.4, 2.1, 2.2, 2.3, 4.4_

- [x] 10.2 (P) データベース操作の統合テスト
  - データベーススキーマ作成をテスト
  - 挿入とクエリ操作をテスト
  - 日付ベースフィルタリングをテスト
  - 分離のため一時データベースを使用
  - _要件: 3.1, 3.3, 3.4, 4.1, 4.2_

- [x] 10.3 E2Eワークフロー検証
  - 完全なstart → capture → pause → resume → reportフローをテスト
  - 正しいディレクトリ構造に画像ファイルが作成されることを検証
  - データベースレコードがキャプチャされたデータと一致することを検証
  - Ctrl+Cでのグレースフルシャットダウンをテスト
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 2.1, 2.2, 2.3, 2.4, 2.5, 4.1, 4.2, 4.3, 4.4, 4.5_
