# 要件ドキュメント

## はじめに
本ドキュメントは、macOS向けの個人用ローカルファースト作業トラッキングツールであるHabit TrackerのMVP要件を定義します。本ツールはバックグラウンドで動作し、定期的にスクリーンショットをキャプチャし、アクティブなアプリケーション/ウィンドウのメタデータを記録し、ログをSQLiteに保存します。主な目標は、手動トラッキングをほぼゼロに減らし、一日の終わりにレビューできるようにすることです。

## 要件

### 要件1: キャプチャループ
**目的:** ユーザーとして、トラッカーが定期的に自動で画面とアクティブなアプリケーションをキャプチャすることで、手動操作なしに作業活動を追跡したい。

#### 受け入れ基準
1. tracker startが実行されると、Habit Trackerは設定された間隔（デフォルト: 60秒）でスクリーンショットのキャプチャを開始するものとする。
2. Habit Trackerは、macOSのscreencaptureコマンドを使用してJPEG形式で設定可能な品質でスクリーンショットをキャプチャするものとする。
3. キャプチャサイクルが実行されると、Habit TrackerはAppleScript経由でアクティブなアプリケーション名を収集するものとする。
4. キャプチャサイクルが実行されると、Habit TrackerはAppleScript経由でウィンドウタイトルの収集を試みるものとする（取得できない場合は空文字列）。
5. ウィンドウタイトルの取得に失敗した場合、Habit Trackerはクラッシュせずに動作を継続し、空のタイトルを保存するものとする。
6. Habit Trackerは、各キャプチャをSQLiteにタイムスタンプ、アプリ名、ウィンドウタイトル、画像パスとともに行として保存するものとする。

### 要件2: 一時停止と再開
**目的:** ユーザーとして、スクリーンショットキャプチャを一時停止・再開できることで、機密性の高い作業中にプライバシーを保護したい。

#### 受け入れ基準
1. ユーザーがtracker pauseを実行すると、Habit Trackerは設定された場所に一時停止フラグファイルを作成するものとする。
2. 一時停止フラグファイルが存在する間、Habit Trackerは各サイクルでスクリーンショットキャプチャをスキップするものとする。
3. ユーザーがtracker resumeを実行すると、Habit Trackerは一時停止フラグファイルを削除するものとする。
4. 一時停止フラグが削除されると、Habit Trackerは次のサイクルで通常のスクリーンショットキャプチャを再開するものとする。
5. 一時停止中、Habit Trackerはプロセスを終了せずに実行を継続するものとする。

### 要件3: ストレージとデータベース
**目的:** ユーザーとして、活動データがローカルデータベースに確実に保存されることで、作業パターンを確認・分析したい。

#### 受け入れ基準
1. Habit Trackerは、すべてのメタデータを設定されたパスのSQLiteデータベースに保存するものとする（デフォルト: ~/.habit-tracker/tracker.db）。
2. Habit Trackerは、スクリーンショット画像を日付別に整理されたディレクトリ構造（YYYY-MM-DD/HHMMSS.jpg）に保存するものとする。
3. キャプチャが記録されると、Habit Trackerは以下を保存するものとする: id、captured_at（ISO-8601）、image_path、active_app、window_title、is_paused、is_private。
4. Habit Trackerは、効率的な日付ベースのクエリのためにcaptured_atにインデックスを作成するものとする。
5. データベース操作が失敗した場合、Habit Trackerはエラーをログに記録し、動作を継続するものとする。

### 要件4: 日次レポート
**目的:** ユーザーとして、日々の作業活動のサマリーを生成することで、時間の使い方を振り返りたい。

#### 受け入れ基準
1. ユーザーがtracker report --date YYYY-MM-DDを実行すると、Habit Trackerはその日付のキャプチャのタイムラインを表示するものとする。
2. ユーザーがtracker report --todayを実行すると、Habit Trackerは今日の日付のタイムラインを表示するものとする。
3. Habit Trackerは、各タイムラインエントリを時刻、アクティブアプリ、ウィンドウタイトルとともに表示するものとする。
4. Habit Trackerは、連続するキャプチャをカウントしてアプリケーションごとの使用時間を計算・表示するものとする。
5. 指定された日付にキャプチャが存在しない場合、Habit Trackerは適切なメッセージを表示するものとする。

### 要件5: 設定
**目的:** ユーザーとして、トラッカーの動作を設定することで、自分の好みに合わせてカスタマイズしたい。

#### 受け入れ基準
1. Habit Trackerは、~/.habit-tracker/config.tomlが存在する場合、そこから設定を読み込むものとする。
2. Habit Trackerは、以下の設定をサポートするものとする: interval_seconds、jpeg_quality、db_path、images_dir、pause_file。
3. 設定ファイルが存在しない場合、Habit Trackerはデフォルト値を使用するものとする。
4. ユーザーがコマンドライン引数（--interval、--quality）を指定した場合、設定ファイルの値を上書きするものとする。

### 要件6: CLIインターフェース
**目的:** ユーザーとして、シンプルなコマンドラインインターフェースで、トラッカーを簡単に操作したい。

#### 受け入れ基準
1. Habit Trackerは、キャプチャループを開始するtracker startコマンドを提供するものとする。
2. Habit Trackerは、キャプチャを一時停止するtracker pauseコマンドを提供するものとする。
3. Habit Trackerは、キャプチャを再開するtracker resumeコマンドを提供するものとする。
4. Habit Trackerは、--dateおよび--todayオプション付きのtracker reportコマンドを提供するものとする。
5. 無効なコマンドが入力された場合、Habit Trackerはヘルプ情報を表示するものとする。
6. Habit Trackerは、すべてのコマンドで--helpフラグをサポートするものとする。
