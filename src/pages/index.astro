---
import { getCollection } from "astro:content";
import NewsletterCard from "@/components/NewsletterCard.astro";
import PostCard from "@/components/PostCard.astro";
import { ScrapboxCardList } from "@/components/scrapbox";
import BaseLayout from "@/layouts/BaseLayout.astro";

const posts = await getCollection("posts", ({ data }) => !data.draft);
const sortedPosts = posts.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);
const latestPosts = sortedPosts.slice(0, 3);

const newsletters = await getCollection("newsletters");
const sortedNewsletters = newsletters.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);
const latestNewsletter =
  sortedNewsletters.length > 0 ? sortedNewsletters[0] : null;
---

<BaseLayout title="KJR020's Blog" description="KJR020の技術ブログ">
  <div class="index-wrapper">
    <div class="container mx-auto px-4 pt-phi-md pb-phi-2xl">
      <section class="mb-phi-2xs pt-phi-xl pb-phi-2xs animate-fade-in-up">
        <div class="flex items-start gap-phi-md">
          <img
            src="/images/avatar.png"
            alt="KJR020"
            class="h-16 w-16 rounded-full ring-2 ring-border hidden sm:block"
          />
          <div>
            <h1
              class="font-bold font-heading tracking-tight mb-phi-2xs"
              style="font-size: var(--font-size-title1); line-height: var(--lh-tight);"
            >
              KJR020's Blog
            </h1>
            <p
              class="text-base text-muted-foreground max-w-lg"
              style="line-height: var(--lh-body);"
            >
              Webエンジニアによる技術ブログ兼思考ログ。<br
                class="hidden sm:inline"
              />
              日々の学びや感じたことを日記的に書いています。
            </p>
          </div>
        </div>
      </section>
      <section
        class="py-phi-xl animate-fade-in-up"
        style="animation-delay: 80ms"
      >
        <div class="flex items-center justify-between mb-phi-md">
          <h2
            class="font-bold font-heading tracking-tight border-l-2 border-link pl-3"
            style="font-size: var(--font-size-title3); line-height: var(--lh-tight);"
          >
            Latest Posts
          </h2>
          {
            sortedPosts.length > 3 && (
              <a
                href="/archive"
                class="flex items-center gap-1 text-xs text-muted-foreground/60 hover:text-muted-foreground transition-colors"
              >
                すべて見る
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="12"
                  height="12"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="m9 18 6-6-6-6" />
                </svg>
              </a>
            )
          }
        </div>
        <div class="grid gap-phi-xs">
          {latestPosts.map((post) => <PostCard post={post} />)}
        </div>
      </section>

      {
        latestNewsletter && (
          <section
            class="py-phi-xl animate-fade-in-up"
            style="animation-delay: 130ms"
          >
            <div class="flex items-center justify-between mb-phi-md">
              <h2
                class="font-bold font-heading tracking-tight border-l-2 border-link pl-3"
                style="font-size: var(--font-size-title3); line-height: var(--lh-tight);"
              >
                Tech Trends
              </h2>
              <a
                href="/newsletters"
                class="flex items-center gap-1 text-xs text-muted-foreground/60 hover:text-muted-foreground transition-colors"
              >
                すべて見る
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="12"
                  height="12"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="m9 18 6-6-6-6" />
                </svg>
              </a>
            </div>
            <div class="grid gap-phi-xs">
              <NewsletterCard newsletter={latestNewsletter} />
            </div>
          </section>
        )
      }

      <section
        class="py-phi-xl animate-fade-in-up"
        style="animation-delay: 210ms"
      >
        <div class="flex items-center justify-between mb-phi-md">
          <h2
            class="font-bold font-heading tracking-tight border-l-2 border-link pl-3"
            style="font-size: var(--font-size-title3); line-height: var(--lh-tight);"
          >
            Scrapbox
          </h2>
          <a
            href="https://scrapbox.io/KJR020"
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center gap-1 text-xs text-muted-foreground/60 hover:text-muted-foreground transition-colors"
          >
            すべて見る
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="12"
              height="12"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M15 3h6v6"></path>
              <path d="M10 14 21 3"></path>
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"
              ></path>
            </svg>
          </a>
        </div>
        <ScrapboxCardList project="KJR020" client:load />
      </section>
    </div>
  </div>
</BaseLayout>

<style>
  .index-wrapper {
    position: relative;
  }

  .index-wrapper > .container {
    position: relative;
  }

  .index-wrapper > .container > section + section {
    border-top: 1px solid var(--border);
    padding-top: 1.618rem; /* φ */
  }

  .index-wrapper :global([data-slot="card"]:hover) {
    background: hsl(var(--accent) / 0.5);
  }
</style>
