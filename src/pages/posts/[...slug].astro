---
import { getCollection, render } from "astro:content";
import { Comments } from "@/components/Comments";
import PostMeta from "@/components/PostMeta.astro";
import { TableOfContents } from "@/components/toc";
import type { HeadingItem } from "@/components/toc";
import BaseLayout from "@/layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings: rawHeadings } = await render(post);

// h2, h3のみを抽出して型変換
const headings: HeadingItem[] = rawHeadings
  .filter((h) => h.depth === 2 || h.depth === 3)
  .map((h) => ({
    id: h.slug,
    text: h.text,
    level: h.depth as 2 | 3,
  }));

// Giscus configuration from environment variables
const giscusRepo = import.meta.env.PUBLIC_GISCUS_REPO as `${string}/${string}`;
const giscusRepoId = import.meta.env.PUBLIC_GISCUS_REPO_ID;
const giscusCategory = import.meta.env.PUBLIC_GISCUS_CATEGORY;
const giscusCategoryId = import.meta.env.PUBLIC_GISCUS_CATEGORY_ID;
---

<BaseLayout
  title={`${post.data.title} - KJR020's Blog`}
  description={post.data.description}
>
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <div class="lg:grid lg:grid-cols-[minmax(0,1fr)_250px] lg:gap-8">
      {/* 記事本文 */}
      <article class="min-w-0">
        <header class="mb-8">
          <h1 class="text-3xl font-bold mb-4">{post.data.title}</h1>
          <PostMeta date={post.data.date} tags={post.data.tags} />
        </header>

        <div class="prose prose-neutral dark:prose-invert max-w-none">
          <Content />
        </div>

        <Comments
          repo={giscusRepo}
          repoId={giscusRepoId}
          category={giscusCategory}
          categoryId={giscusCategoryId}
          client:only="react"
        />
      </article>

      {/* デスクトップ用目次（右側サイドバー） */}
      <aside class="hidden lg:block">
        <TableOfContents
          headings={headings}
          avatarSrc="/images/avatar.png"
          avatarAlt="KJR020"
          client:load
        />
      </aside>
    </div>
  </div>
</BaseLayout>

<script is:inline>
  // コードブロックにコピーボタンを追加
  function addCopyButtons() {
    const codeBlocks = document.querySelectorAll('pre:not(.copy-button-added)');

    codeBlocks.forEach((pre) => {
      pre.classList.add('copy-button-added');

      // コンテナを作成
      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper';
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      // コピーボタンを作成
      const copyButton = document.createElement('button');
      copyButton.className = 'copy-button';
      copyButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      `;
      copyButton.setAttribute('aria-label', 'コードをコピー');
      wrapper.appendChild(copyButton);

      // クリックイベント
      copyButton.addEventListener('click', async () => {
        const code = pre.querySelector('code')?.textContent || pre.textContent || '';

        try {
          await navigator.clipboard.writeText(code);
          copyButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          `;
          copyButton.classList.add('copied');

          setTimeout(() => {
            copyButton.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            `;
            copyButton.classList.remove('copied');
          }, 2000);
        } catch (err) {
          console.error('コピーに失敗しました:', err);
        }
      });
    });
  }

  // DOMContentLoadedで確実に実行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', addCopyButtons);
  } else {
    addCopyButtons();
  }
  // View Transitions対応
  document.addEventListener('astro:page-load', addCopyButtons);
</script>

<style is:global>
  .prose {
    --tw-prose-body: var(--foreground);
    --tw-prose-headings: var(--foreground);
    --tw-prose-links: var(--primary);
    --tw-prose-bold: var(--foreground);
    --tw-prose-code: var(--foreground);
  }

  .prose h2 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-size: 1.5rem;
    font-weight: 700;
    border-bottom: 1px solid var(--border);
    padding-bottom: 0.5rem;
  }

  .prose h3 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
  }

  .prose p {
    margin-top: 1rem;
    margin-bottom: 1rem;
    line-height: 1.75;
  }

  .prose ul,
  .prose ol {
    margin-top: 1rem;
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }

  .prose li {
    margin-top: 0.25rem;
    margin-bottom: 0.25rem;
  }

  /* インラインコード */
  .prose :not(pre) > code {
    background-color: var(--muted);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  /* コードブロック（Shikiでハイライトされたもの） */
  .prose pre {
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-size: 0.875rem;
    line-height: 1.7;
  }

  .prose pre code {
    background-color: transparent;
    padding: 0;
    border-radius: 0;
    font-size: inherit;
  }

  /* Shikiのスタイルを上書きしない */
  .prose pre[data-language] {
    background-color: var(--shiki-light-bg, #f6f8fa);
  }

  .dark .prose pre[data-language] {
    background-color: var(--shiki-dark-bg, #24292e);
  }

  /* Astro標準のShikiスタイル */
  .astro-code {
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-top: 1rem;
    margin-bottom: 1rem;
  }

  .prose a {
    color: var(--primary);
    text-decoration: underline;
  }

  .prose a:hover {
    opacity: 0.8;
  }

  /* コードブロックのコピーボタン */
  .code-block-wrapper {
    position: relative;
  }

  .copy-button {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    padding: 0.5rem;
    background-color: var(--muted);
    border: 1px solid var(--border);
    border-radius: 0.375rem;
    color: var(--muted-foreground);
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s, background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .code-block-wrapper:hover .copy-button {
    opacity: 1;
  }

  .copy-button:hover {
    background-color: var(--accent);
    color: var(--accent-foreground);
  }

  .copy-button.copied {
    color: hsl(142 76% 36%);
  }

  .prose blockquote {
    border-left: 4px solid var(--border);
    padding-left: 1rem;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-style: italic;
    color: var(--muted-foreground);
  }
</style>
